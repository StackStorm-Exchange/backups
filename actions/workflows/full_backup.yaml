---
version: '1.0'
description: Workflow that backs up the StackStorm MongoDB database
input:
  - path
  - mongodb_admin_username
  - mongodb_admin_password
  - retention_days
  - backup_timeout
  - mongodb_host

vars:
  - mongo_backup_success: false

output:
  - mongodb_dump_archive: '{{ ctx().mongodb_dump_archive }}'

tasks:
  date:
    action: core.local
    input:
      cmd: "date +%Y%m%d_%H%M%S"
    next:
      - when: '{{ succeeded() }}'
        publish:
          - date: '{{ result().stdout }}'
        do:
          - mongodb_backup

  mongodb_backup:
    action: backups.mongodb_backup
    input:
      path: '{{ ctx().path }}'
      date: '{{ ctx().date }}'
      mongodb_admin_username: '{{ ctx().mongodb_admin_username }}'
      mongodb_admin_password: '{{ ctx().mongodb_admin_password }}'
      mongodb_host: '{{ ctx().mongodb_host }}'
      retention_days: '{{ ctx().retention_days }}'
      backup_timeout: '{{ ctx().backup_timeout }}'
    next:
      - when: "{{ succeeded() }}"
        publish:
          - mongo_backup_success: "{{ true }}"
          - mongodb_dump_archive: '{{ result().output.mongodb_dump_archive }}'
        do:
          - noop
      - when: "{{ failed() }}"
        publish:
          - mongo_backup_success: "{{ false }}"
          - mongodb_dump_archive: '{{ result().output.mongodb_dump_archive }}'
        do:
          - fail
